<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <!-- –û—Ç–∫–ª—é—á–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ —Ç–∞–ø–µ, —á—Ç–æ–±—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –¥–µ—Ä–≥–∞–ª—Å—è -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NEXUS | INK GAME OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-main: #050505;
            --bg-panel: rgba(15, 15, 15, 0.98); /* –ß—É—Ç—å –º–µ–Ω–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
            --border: rgba(255, 255, 255, 0.15);
            --accent: #ffffff;
            --accent-glow: rgba(255, 255, 255, 0.2);
            --gold: #FFD700;
        }

        [data-theme="matrix"] { --accent: #00ff00; --border: rgba(0, 255, 0, 0.3); }
        [data-theme="crimson"] { --accent: #ff0000; --border: rgba(255, 0, 0, 0.3); }

        body { 
            background-color: var(--bg-main); 
            color: white; 
            font-family: 'Space Grotesk', sans-serif; 
            transition: all 0.4s ease; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            min-height: 100dvh;
        }
        
        /* –ë–ª–æ–∫–∏—Ä—É–µ–º —Å–∫—Ä–æ–ª–ª –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–ª–∞, –∫–æ–≥–¥–∞ –æ—Ç–∫—Ä—ã—Ç–æ –º–µ–Ω—é */
        body.modal-open { overflow: hidden; position: fixed; width: 100%; height: 100dvh; }

        .font-tech { font-family: 'Syncopate', sans-serif; }
        .glass-panel { background: var(--bg-panel); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); }
        
        .btn-nexus { 
            background: var(--accent); color: black; font-weight: 800; 
            letter-spacing: 1px; transition: all 0.3s; text-transform: uppercase;
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            touch-action: manipulation;
            user-select: none;
            min-height: 50px; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ –∫–ª–∏–∫–∞ */
        }
        .btn-nexus:active { transform: scale(0.96); opacity: 0.8; }
        
        .btn-icon { background: rgba(255,255,255,0.1); color: white; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: 0.3s; cursor: pointer; }

        /* Mobile Input Fix */
        input, textarea { 
            background: rgba(255,255,255,0.05) !important; 
            border: 1px solid var(--border) !important; 
            color: white !important; 
            padding: 16px; /* –ë–æ–ª—å—à–µ –ø–∞–¥–¥–∏–Ω–≥ –¥–ª—è –ø–∞–ª—å—Ü–∞ */
            font-size: 16px !important; 
            border-radius: 4px;
            width: 100%;
            -webkit-appearance: none;
        }
        input:focus { border-color: var(--accent) !important; outline: none; background: rgba(255,255,255,0.1) !important; }

        /* DRAWER FIX - –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï */
        .drawer {
            position: fixed; 
            top: 0; 
            right: 0; 
            width: 100%; 
            max-width: 450px; 
            height: 100dvh; /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ */
            background: #080808; 
            border-left: 1px solid var(--border);
            z-index: 1000; /* –ü–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ */
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* –î–µ–ª–∞–µ–º —Å–∞–º drawer —Å–∫—Ä–æ–ª–ª—è—â–∏–º—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º */
            overflow-y: auto; 
            -webkit-overflow-scrolling: touch;
            
            display: flex;
            flex-direction: column;
        }

        .drawer-content {
            padding: 2rem;
            padding-bottom: 150px; /* –û–≥—Ä–æ–º–Ω—ã–π –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É –¥–ª—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã */
            flex-grow: 1;
        }
        
        /* Mobile overrides */
        @media(max-width: 640px) {
            .drawer { 
                max-width: 100%; 
                border-left: none;
            }
            .drawer-content {
                padding: 1.5rem;
                padding-bottom: 50vh; /* –ü–æ–ª-—ç–∫—Ä–∞–Ω–∞ –ø—É—Å—Ç–æ—Ç—ã —Å–Ω–∏–∑—É, —á—Ç–æ–±—ã –ø—Ä–æ—Å–∫—Ä–æ–ª–ª–∏—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É */
            }
        }
        
        .drawer.active { transform: translateX(0); }

        /* –®–∞–ø–∫–∞ drawer'–∞ –≤—Å–µ–≥–¥–∞ —Å–≤–µ—Ä—Ö—É */
        .drawer-header {
            position: sticky;
            top: 0;
            background: #080808;
            z-index: 10;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 900; display: none; backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        #admin-dashboard {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            background: #000; z-index: 2000; 
            transform: translateY(-100%);
            transition: transform 0.4s ease;
            overflow-y: auto;
        }
        #admin-dashboard.active { transform: translateY(0); }
    </style>
</head>
<body class="pb-10">
    <canvas id="snow-canvas" class="fixed top-0 left-0 w-full h-full pointer-events-none z-0"></canvas>
    <div id="overlay" onclick="closeAllPanels()"></div>

    <!-- Admin Panel -->
    <div id="admin-dashboard">
        <div class="max-w-6xl mx-auto p-4 pb-40">
            <div class="flex justify-between items-center mb-10 border-b border-white/10 pb-5">
                <h2 class="text-2xl font-tech font-bold">–£–ü–†–ê–í–õ–ï–ù–ò–ï</h2>
                <button onclick="logoutAdmin()" class="px-6 py-2 border border-red-500 text-red-500 text-xs">–í–´–•–û–î</button>
            </div>
            
            <div class="glass-panel p-6 space-y-4">
                <h3 class="font-tech text-sm mb-4" id="adm-form-title">–°–û–ó–î–ê–¢–¨ –¢–£–†–ù–ò–†</h3>
                <input type="hidden" id="adm-id">
                <div class="flex gap-2 mb-4">
                    <button onclick="setGameMode('solo')" id="mode-solo" class="flex-1 p-3 border border-white/20 text-xs">–°–û–õ–û</button>
                    <button onclick="setGameMode('squad')" id="mode-squad" class="flex-1 p-3 border border-white/20 text-xs">–û–¢–†–Ø–î–´</button>
                </div>
                <div class="grid grid-cols-1 gap-4">
                    <input type="text" id="adm-format" placeholder="–§–æ—Ä–º–∞—Ç (1x1)">
                    <input type="number" id="adm-team-size" value="1" placeholder="–†–∞–∑–º–µ—Ä –∫–æ–º–∞–Ω–¥—ã">
                    <input type="text" id="adm-prize" placeholder="–ü—Ä–∏–∑">
                    <input type="number" id="adm-max-players" placeholder="–ú–∞–∫—Å. –∏–≥—Ä–æ–∫–æ–≤">
                </div>
                <textarea id="adm-rules" placeholder="–ü—Ä–∞–≤–∏–ª–∞..." class="w-full h-24 mt-4"></textarea>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="resetAdminForm()" class="btn-secondary p-4 flex-1">–°–ë–†–û–°</button>
                    <button onclick="saveTournament()" class="btn-nexus p-4 flex-[2]" id="adm-save-btn">–°–û–ó–î–ê–¢–¨</button>
                </div>
            </div>
            
            <div class="mt-8">
                 <h3 class="font-tech text-sm mb-4">–ê–ö–¢–ò–í–ù–´–ï –¢–£–†–ù–ò–†–´</h3>
                 <div id="adm-tourn-list" class="space-y-3"></div>
            </div>
            
            <div id="adm-control-panel" class="hidden mt-8 p-4 border border-green-500">
                <h3 class="text-green-500 mb-4">–£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–ê–¢–ß–ï–ú</h3>
                <div id="adm-team-list" class="space-y-2"></div>
            </div>

            <div class="mt-8 pb-20">
                <h3 class="text-xs font-tech mb-4">–ë–´–°–¢–†–û–ï –ù–ê–ß–ò–°–õ–ï–ù–ò–ï –ü–û–ë–ï–î</h3>
                <div id="adm-winner-selection" class="grid grid-cols-1 md:grid-cols-3 gap-2"></div>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="relative z-10 max-w-7xl mx-auto p-4 md:p-10">
        <header class="flex justify-between items-center mb-12">
            <h1 class="text-3xl md:text-6xl font-bold font-tech tracking-tighter select-none">INK<span class="opacity-20">_OS</span></h1>
            <div class="flex items-center gap-3">
                <input type="password" id="admin-code" placeholder="KEY" class="bg-white/5 border-none text-center text-xs w-24 !p-2 focus:w-32 transition-all rounded">
                <button onclick="toggleSettings()" class="w-12 h-12 glass-panel flex items-center justify-center active:scale-95 transition text-lg"><i class="fas fa-bars"></i></button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-10">
            <div class="lg:col-span-4 order-1 lg:order-none">
                <div id="profile-card" class="glass-panel p-6 md:p-8"></div>
            </div>
            <div class="lg:col-span-8 space-y-6 order-2 lg:order-none">
                <div id="tournaments-container"></div>
            </div>
        </div>
    </div>

    <!-- Drawer: Registration (FIXED) -->
    <div id="drawer-reg" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h3 class="font-tech text-lg" id="reg-title" data-lang="create_acc">–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</h3>
                <button onclick="closeAllPanels()" class="p-4 -mr-4"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <form onsubmit="event.preventDefault(); handleRegistration();" class="flex flex-col gap-6">
                <div>
                    <label class="text-[10px] uppercase opacity-50 ml-1 font-bold mb-2 block">–ù–∏–∫–Ω–µ–π–º</label>
                    <input type="text" id="reg-nick" placeholder="–í–≤–µ–¥–∏ –Ω–∏–∫" autocomplete="off" autocorrect="off" autocapitalize="off" enterkeyhint="next">
                </div>
                <div>
                    <label class="text-[10px] uppercase opacity-50 ml-1 font-bold mb-2 block">Telegram</label>
                    <input type="text" id="reg-tg" placeholder="@username" autocomplete="off" autocorrect="off" autocapitalize="off" enterkeyhint="done">
                </div>
                
                <div id="reg-wins-container" class="hidden">
                    <label class="text-[10px] uppercase opacity-50 ml-1 font-bold mb-2 block">–ü–æ–±–µ–¥—ã</label>
                    <input type="number" id="reg-wins" disabled>
                </div>
                
                <button type="submit" class="btn-nexus w-full py-5 text-sm shadow-lg mt-4" id="reg-btn">–ì–û–¢–û–í–û</button>
                
                <!-- –ü—É—Å—Ç–æ–π –±–ª–æ–∫, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–ª–∞ –∫–Ω–æ–ø–∫—É –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ -->
                <div class="h-40 w-full"></div>
            </form>
        </div>
    </div>

    <!-- Drawer: Details -->
    <div id="drawer-details" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h3 class="font-tech text-xl" id="det-title">–î–ï–¢–ê–õ–ò</h3>
                <button onclick="closeAllPanels()" class="p-4 -mr-4"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-6">
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/5 p-4 rounded"><p class="text-[9px] opacity-40 uppercase">–ü—Ä–∏–∑</p><p class="text-xl font-bold text-yellow-500" id="det-prize">-</p></div>
                    <div class="bg-white/5 p-4 rounded"><p class="text-[9px] opacity-40 uppercase">–§–æ—Ä–º–∞—Ç</p><p class="text-xl font-bold" id="det-format">-</p></div>
                </div>
                <div>
                    <p class="text-[9px] opacity-40 uppercase mb-2">–ü—Ä–∞–≤–∏–ª–∞</p>
                    <p class="text-sm leading-relaxed bg-white/5 p-4 rounded font-medium select-text" id="det-rules">-</p>
                </div>
                <div>
                    <p class="text-[9px] opacity-40 uppercase mb-3 flex justify-between"><span>–£—á–∞—Å—Ç–Ω–∏–∫–∏</span><span id="det-count">0/0</span></p>
                    <div id="det-participants" class="space-y-2 max-h-60 overflow-y-auto pr-2 border border-white/5 p-2 rounded"></div>
                </div>
                <div id="det-bracket-area" class="hidden pt-4 border-t border-white/10">
                    <p class="text-[9px] opacity-40 uppercase mb-3">–°–ï–¢–ö–ê</p>
                    <div id="det-bracket-grid" class="grid grid-cols-1 gap-2"></div>
                </div>
                <div id="det-action-area" class="pt-4 sticky bottom-0 bg-[#080808] pb-4 z-20"></div>
            </div>
        </div>
    </div>

    <!-- Drawer: Team Join -->
    <div id="drawer-team" class="drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <h3 class="font-tech text-lg" data-lang="reg_tourn_title">–£–ß–ê–°–¢–ò–ï</h3>
                <button onclick="closeAllPanels()" class="p-4 -mr-4"><i class="fas fa-arrow-left text-xl"></i></button>
            </div>
            <div id="team-action-area" class="space-y-6"></div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="fixed top-0 right-0 h-full w-full max-w-[300px] bg-black border-l border-white/10 z-[2000] transform translate-x-full transition-transform duration-300">
        <div class="p-8 h-full overflow-y-auto">
            <div class="flex justify-between items-center mb-10">
                <h2 class="font-tech text-sm" data-lang="settings">–ù–ê–°–¢–†–û–ô–ö–ò</h2>
                <button onclick="closeAllPanels()"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-6 pb-20">
                <div class="flex gap-2">
                    <button onclick="changeLang('ru')" class="flex-1 p-3 text-xs border border-white/20">RU</button>
                    <button onclick="changeLang('en')" class="flex-1 p-3 text-xs border border-white/20">EN</button>
                </div>
                <div class="border-t border-white/10 pt-4 space-y-3">
                    <button onclick="toggleSnow()" class="w-full p-4 border border-white/10 text-xs flex justify-between items-center"><span>–°–ù–ï–ì –í–ö–õ/–í–´–ö–õ</span><i class="fas fa-snowflake"></i></button>
                </div>
                <div class="pt-4 border-t border-white/5">
                    <p class="text-[10px] opacity-50 uppercase mb-3">–¢–ï–ú–ê</p>
                    <button onclick="setTheme('void')" class="w-full p-3 mb-2 text-xs border border-white/10">VOID</button>
                    <button onclick="setTheme('matrix')" class="w-full p-3 mb-2 text-xs border border-green-500/30 text-green-500">MATRIX</button>
                    <button onclick="setTheme('crimson')" class="w-full p-3 text-xs border border-red-500/30 text-red-500">CRIMSON</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification-area" class="fixed top-6 right-6 z-[3000] flex flex-col gap-3 pointer-events-none w-full max-w-[300px] px-4 md:px-0 ml-auto"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCK7gn8Xl-AW93FTni7q7Rx1QTUw0ILiCs",
            authDomain: "ink-game-843c1.firebaseapp.com",
            databaseURL: "https://ink-game-843c1-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "ink-game-843c1",
            storageBucket: "ink-game-843c1.appspot.com", 
            messagingSenderId: "547943681956",
            appId: "1:547943681956:web:aa7db2830eca6438f7fb31"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // EXPORTS
        window.remove = remove;
        window.ref = ref;
        window.db = db;

        let state = {
            player: JSON.parse(localStorage.getItem('ink_player')) || null,
            tournaments: {},
            teams: {}, 
            allPlayers: {},
            gameMode: 'solo',
            currentViewTournId: null,
            adminSelectedTournId: null
        };

        // --- SYNC ---
        onValue(ref(db, 'tournaments'), (snap) => {
            state.tournaments = snap.val() || {};
            renderTournamentList(); 
            renderMainTournaments(); 
        });

        onValue(ref(db, 'teams'), (snap) => {
            state.teams = snap.val() || {};
            if(document.getElementById('drawer-details').classList.contains('active') && state.currentViewTournId) {
                showTournamentDetails(state.currentViewTournId);
            }
            renderTournamentList();
            renderMainTournaments();
            if(state.adminSelectedTournId) renderAdminControlPanel(state.adminSelectedTournId);
        });

        onValue(ref(db, 'users'), (snap) => {
            state.allPlayers = snap.val() || {};
            renderAdminTools();
            if(state.player && state.allPlayers[state.player.nick]) {
                const updated = state.allPlayers[state.player.nick];
                if(JSON.stringify(updated) !== JSON.stringify(state.player)) {
                    state.player = updated;
                    localStorage.setItem('ink_player', JSON.stringify(updated));
                    renderProfile();
                }
            }
        });

        // --- ADMIN ---
        window.setGameMode = function(m) {
            state.gameMode = m;
            document.getElementById('mode-solo').style.background = m === 'solo' ? 'white' : 'transparent';
            document.getElementById('mode-solo').style.color = m === 'solo' ? 'black' : 'white';
            document.getElementById('mode-squad').style.background = m === 'squad' ? 'white' : 'transparent';
            document.getElementById('mode-squad').style.color = m === 'squad' ? 'black' : 'white';
            document.getElementById('adm-team-size').value = m === 'solo' ? 1 : 2;
        };

        window.resetAdminForm = function() {
            document.getElementById('adm-id').value = '';
            document.getElementById('adm-format').value = '';
            document.getElementById('adm-prize').value = '';
            document.getElementById('adm-max-players').value = '';
            document.getElementById('adm-rules').value = '';
            document.getElementById('adm-team-size').value = 1;
            setGameMode('solo');
            document.getElementById('adm-form-title').innerText = "–°–û–ó–î–ê–¢–¨ –¢–£–†–ù–ò–†";
            document.getElementById('adm-save-btn').innerText = "–°–û–ó–î–ê–¢–¨";
            document.getElementById('adm-control-panel').classList.add('hidden');
            state.adminSelectedTournId = null;
        };

        window.editTournament = function(id) {
            const trn = state.tournaments[id];
            if(!trn) return;
            document.getElementById('adm-id').value = id;
            document.getElementById('adm-format').value = trn.format;
            document.getElementById('adm-prize').value = trn.prize;
            document.getElementById('adm-max-players').value = trn.maxPlayers;
            document.getElementById('adm-rules').value = trn.rules;
            document.getElementById('adm-team-size').value = trn.teamSize;
            setGameMode(trn.mode);
            document.getElementById('adm-form-title').innerText = "–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨";
            document.getElementById('adm-save-btn').innerText = "–°–û–•–†–ê–ù–ò–¢–¨";
        };

        window.manageTournament = function(id) {
            state.adminSelectedTournId = id;
            renderAdminControlPanel(id);
        };

        window.renderAdminControlPanel = function(id) {
            const trn = state.tournaments[id];
            if(!trn) return;
            document.getElementById('adm-control-panel').classList.remove('hidden');
            
            const trnTeams = state.teams[id] ? Object.values(state.teams[id]) : [];
            if(trnTeams.length === 0) { 
                document.getElementById('adm-team-list').innerHTML = `<p class="text-[10px] opacity-30">–ù–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>`; 
                return; 
            }

            document.getElementById('adm-team-list').innerHTML = trnTeams.map(t => `
                <div class="flex justify-between items-center p-2 bg-white/5 border-l-2 border-green-500/20">
                    <div>
                         <span class="text-[11px] font-bold block">${t.name}</span>
                         <span class="text-[9px] opacity-50">${t.members.map(m=>m.nick).join(', ')}</span>
                    </div>
                    <button onclick="declareWinner('${id}', '${t.id}')" class="px-2 py-1 bg-green-500 text-black text-[9px] font-bold rounded">üèÜ WIN</button>
                </div>
            `).join('');
        };

        window.declareWinner = async function(tournId, teamId) {
            const team = state.teams[tournId][teamId];
            if(!team) return;

            if(confirm(`–ü–æ–±–µ–¥–∞ ${team.name}?`)) {
                for(let member of team.members) {
                    const userRef = ref(db, 'users/' + member.nick);
                    const snap = await get(userRef);
                    if(snap.exists()) {
                        await update(userRef, { wins: (snap.val().wins || 0) + 1 });
                    } else {
                        await set(userRef, { nick: member.nick, wins: 1, tg: '-' });
                    }
                }
                notify(`–ü–æ–±–µ–¥–∞ –∑–∞—Å—á–∏—Ç–∞–Ω–∞!`, 'success');
                if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç—É—Ä–Ω–∏—Ä?")) {
                    await remove(ref(db, `tournaments/${tournId}`));
                    await remove(ref(db, `teams/${tournId}`));
                    resetAdminForm();
                }
            }
        };

        window.saveTournament = async function() {
            const id = document.getElementById('adm-id').value || "tourn_" + Date.now();
            const data = {
                id: id,
                format: document.getElementById('adm-format').value,
                prize: document.getElementById('adm-prize').value,
                maxPlayers: document.getElementById('adm-max-players').value,
                rules: document.getElementById('adm-rules').value,
                teamSize: document.getElementById('adm-team-size').value,
                mode: state.gameMode
            };
            await update(ref(db, `tournaments/${id}`), data);
            notify(t('updated'), 'success');
            resetAdminForm();
        };

        window.deleteTournament = async function(id) {
            if(confirm(t('confirm_delete'))) {
                await remove(ref(db, `tournaments/${id}`));
                await remove(ref(db, `teams/${id}`));
                notify(t('deleted'), 'success');
                if(id === document.getElementById('adm-id').value) resetAdminForm();
            }
        };

        window.renderTournamentList = function() {
            const list = document.getElementById('adm-tourn-list');
            const tourns = Object.values(state.tournaments);
            if(tourns.length === 0) { list.innerHTML = `<p class="text-xs opacity-30 text-center py-4">–ù–µ—Ç —Ç—É—Ä–Ω–∏—Ä–æ–≤</p>`; return; }
            list.innerHTML = tourns.map(t => {
                const count = state.teams[t.id] ? Object.keys(state.teams[t.id]).length : 0;
                return `
                <div class="bg-white/5 p-3 flex flex-col gap-2 text-xs border-l-2 border-white/20">
                    <div class="flex justify-between">
                        <div><p class="font-bold">${t.format} <span class="opacity-50">(${t.mode})</span></p><p class="opacity-50">${t.prize}</p></div>
                        <div class="text-right"><p>${count}/${t.maxPlayers}</p></div>
                    </div>
                    <div class="flex gap-2 pt-2 border-t border-white/5 mt-1">
                        <button onclick="manageTournament('${t.id}')" class="flex-1 bg-green-500/20 text-green-500 py-1 text-[9px] font-bold">–£–ü–†–ê–í–õ–ï–ù–ò–ï</button>
                        <button onclick="editTournament('${t.id}')" class="bg-white/10 px-3 py-1 text-[9px]">–†–ï–î</button>
                        <button onclick="deleteTournament('${t.id}')" class="bg-red-500/20 text-red-500 px-3 py-1 text-[9px]">X</button>
                    </div>
                </div>`;
            }).join('');
        };

        // --- CLIENT SIDE ---
        window.renderMainTournaments = function() {
            const container = document.getElementById('tournaments-container');
            const tourns = Object.values(state.tournaments);
            if(tourns.length === 0) {
                container.innerHTML = `<div class="glass-panel p-10 text-center opacity-20 border-dashed"><p class="font-tech text-xs">${t('no_events')}</p></div>`;
                return;
            }
            container.innerHTML = tourns.map(trn => {
                const trnTeams = state.teams[trn.id] || {};
                const totalJoined = Object.keys(trnTeams).length;
                return `
                <div class="glass-panel p-1 tournament-card-hover overflow-hidden" onclick="showTournamentDetails('${trn.id}')">
                    <div class="p-6 md:p-10 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div class="w-full text-center md:text-left">
                            <span class="text-[9px] font-black bg-white text-black px-2 py-1 uppercase">${t('active_tourn')}</span>
                            <h2 class="text-3xl md:text-5xl font-tech mt-4 tracking-tighter">${trn.prize}</h2>
                            <p class="text-xs mt-2 opacity-50 uppercase tracking-widest">${trn.format} / ${t(trn.mode)}</p>
                        </div>
                        <div class="flex flex-col items-center md:items-end w-full md:w-auto">
                            <div class="text-right mb-4 hidden md:block">
                                <p class="text-[9px] opacity-30">${t('participants')}</p>
                                <p class="text-2xl font-tech">${totalJoined} / ${trn.maxPlayers}</p>
                            </div>
                            <button class="btn-nexus px-10 py-4 text-xs w-full md:w-auto">${t('about_btn')}</button>
                        </div>
                    </div>
                    <div class="h-1 bg-white/5 w-full"><div class="h-full bg-white transition-all" style="width: ${(totalJoined/trn.maxPlayers)*100}%"></div></div>
                </div>`;
            }).join('');
        };

        window.showTournamentDetails = function(id) {
            const trn = state.tournaments[id];
            if(!trn) return;
            state.currentViewTournId = id;
            document.getElementById('det-title').innerText = trn.format;
            document.getElementById('det-prize').innerText = trn.prize;
            document.getElementById('det-format').innerText = trn.format;
            document.getElementById('det-rules').innerText = trn.rules;
            const trnTeams = state.teams[id] ? Object.values(state.teams[id]) : [];
            document.getElementById('det-count').innerText = `${trnTeams.length} / ${trn.maxPlayers}`;
            document.getElementById('det-participants').innerHTML = trnTeams.map(tm => `
                <div class="bg-white/5 p-3 text-[11px] flex justify-between items-center border-b border-white/5">
                    <span class="font-bold tracking-wider">${tm.name}</span>
                    <span class="opacity-30">${tm.members.length} —á–µ–ª.</span>
                </div>
            `).join('') || `<p class="text-center opacity-20 py-4 text-xs">${t('nobody_joined')}</p>`;
            const bracketArea = document.getElementById('det-bracket-area');
            const bracketGrid = document.getElementById('det-bracket-grid');
            if(trnTeams.length >= 2) {
                bracketArea.classList.remove('hidden');
                let html = '';
                for(let i=0; i<trnTeams.length; i+=2) {
                    if(trnTeams[i+1]) {
                        html += `<div class="bg-white/5 p-3 flex justify-between text-[10px] items-center">
                                    <span class="font-bold">${trnTeams[i].name}</span>
                                    <span class="opacity-20 font-tech">VS</span>
                                    <span class="font-bold">${trnTeams[i+1].name}</span>
                                </div>`;
                    }
                }
                bracketGrid.innerHTML = html;
            } else { bracketArea.classList.add('hidden'); }
            document.getElementById('det-action-area').innerHTML = `<button onclick="openJoinMenu('${id}')" class="btn-nexus w-full py-5 shadow-lg" data-lang="join_btn">${t('join_btn')}</button>`;
            toggleDrawer('drawer-details');
        };

        window.openJoinMenu = function(tournId) {
            if(!state.player) return openRegisterDrawer();
            const trn = state.tournaments[tournId];
            if(!trn) return;
            const area = document.getElementById('team-action-area');
            const trnTeams = state.teams[tournId] ? Object.values(state.teams[tournId]) : [];
            const myTeam = trnTeams.find(t => t.members.some(m => m.nick === state.player.nick));
            if (myTeam) {
                area.innerHTML = `<div class="glass-panel p-6 border-l-4 border-white"><h4 class="font-tech">${myTeam.name}</h4><p class="text-xs opacity-50 mt-4">${t('already_in')}</p></div>`;
            } else if(trn.mode === 'solo') {
                area.innerHTML = `<p class="text-sm opacity-50 bg-white/5 p-4 mb-4 rounded border border-white/10">${t('confirm_solo')}</p><button onclick="createTeam('${tournId}', '${state.player.nick}')" class="btn-nexus w-full py-5">${t('confirm')}</button>`;
            } else {
                area.innerHTML = `
                    <input type="text" id="new-team-name" placeholder="${t('team_name_ph')}" class="w-full mb-4">
                    <button onclick="createTeam('${tournId}')" class="btn-nexus w-full py-4 mb-4">${t('create_squad')}</button>
                    <div class="relative py-4 text-center opacity-20 text-[10px] uppercase tracking-widest">${t('or_join')}</div>
                    <div id="joinable-list" class="space-y-2"></div>
                `;
                setTimeout(() => {
                    const joinables = trnTeams.filter(t => t.members.length < t.max);
                    document.getElementById('joinable-list').innerHTML = joinables.map(t => `<button onclick="joinT('${tournId}', '${t.id}')" class="w-full p-4 bg-white/5 text-xs flex justify-between items-center border border-white/10 hover:bg-white/10 transition"><span class="font-bold">${t.name}</span><span>${t.members.length}/${t.max}</span></button>`).join('') || `<p class="text-xs opacity-20 text-center">${t('no_squads')}</p>`;
                }, 10);
            }
            toggleDrawer('drawer-team');
        };

        window.createTeam = async function(tournId, customNick) {
            const name = customNick || document.getElementById('new-team-name').value;
            if(!name) return;
            const trn = state.tournaments[tournId];
            const tid = "t_" + Date.now();
            const teamData = { id: tid, name: name.toUpperCase(), members: [{nick: state.player.nick}], totalWins: state.player.wins || 0, max: trn.teamSize };
            await set(ref(db, `teams/${tournId}/${tid}`), teamData);
            closeAllPanels(); notify(t('you_joined'), 'success');
        };

        window.joinT = async function(tournId, teamId) {
            const teamRef = ref(db, `teams/${tournId}/${teamId}`);
            const tDat = (await get(teamRef)).val();
            if(!tDat || tDat.members.some(m => m.nick === state.player.nick)) return notify(t('already_in_team'), 'warning');
            await update(teamRef, { members: [...tDat.members, {nick: state.player.nick}] });
            closeAllPanels(); notify(t('joined_squad'), 'success');
        };

        // --- AUTH ---
        window.openRegisterDrawer = function() {
            document.getElementById('reg-nick').value = '';
            document.getElementById('reg-nick').disabled = false;
            document.getElementById('reg-tg').value = '';
            document.getElementById('reg-wins').value = '0'; 
            document.getElementById('reg-wins-container').classList.add('hidden'); // Hide wins on registration
            document.getElementById('reg-title').innerText = t('create_acc');
            document.getElementById('reg-btn').innerText = t('done');
            toggleDrawer('drawer-reg');
        }

        window.openEditProfile = function() {
            if(!state.player) return;
            document.getElementById('reg-nick').value = state.player.nick;
            document.getElementById('reg-nick').disabled = true; 
            document.getElementById('reg-tg').value = state.player.tg;
            document.getElementById('reg-wins').value = state.player.wins || 0; 
            document.getElementById('reg-wins-container').classList.remove('hidden');
            document.getElementById('reg-title').innerText = t('edit_profile');
            document.getElementById('reg-btn').innerText = t('save_changes');
            toggleDrawer('drawer-reg');
        }

        window.handleRegistration = async function() {
            const nick = document.getElementById('reg-nick').value.trim();
            const tg = document.getElementById('reg-tg').value.trim();
            const winsInput = document.getElementById('reg-wins').value; 
            if(!nick || !tg) return notify(t('fill_all_fields'), 'warning');
            
            let currentWins = 0;
            if(state.player && state.player.nick === nick) {
                 currentWins = parseInt(winsInput) || state.player.wins || 0;
            } else {
                const snap = await get(ref(db, 'users/' + nick));
                if(snap.exists()) {
                    currentWins = snap.val().wins || 0;
                }
            }

            const userData = { nick, tg, wins: currentWins };
            await set(ref(db, 'users/' + nick), userData);
            state.player = userData;
            localStorage.setItem('ink_player', JSON.stringify(userData));
            renderProfile();
            closeAllPanels();
            notify(t('profile_saved'), 'success');
        };

        window.renderProfile = function() {
            const card = document.getElementById('profile-card');
            if(!state.player) { card.innerHTML = `<button onclick="openRegisterDrawer()" class="btn-nexus w-full py-4 text-xs">${t('register')}</button>`; return; }
            card.innerHTML = `<div class="flex flex-col items-center relative py-2"><div class="absolute top-0 right-0"><button onclick="openEditProfile()" class="btn-icon" title="${t('edit_profile')}"><i class="fas fa-pen text-[10px]"></i></button></div><p class="text-[9px] opacity-30 uppercase">Operator</p><h3 class="font-tech text-3xl my-2 break-all text-center">${state.player.nick}</h3><p class="text-xs text-accent opacity-70 tracking-widest">${state.player.tg}</p><div class="mt-6 pt-4 border-t border-white/5 flex justify-between items-center w-full"><span class="text-xs opacity-50 font-bold">${t('wins')}: ${state.player.wins || 0}</span><span class="text-[10px] text-green-500 font-bold tracking-widest">ONLINE</span></div></div>`;
        }

        window.renderAdminTools = function() {
            const cont = document.getElementById('adm-winner-selection');
            cont.innerHTML = Object.values(state.allPlayers).map(u => `<div class="flex justify-between items-center p-2 bg-white/5 rounded border border-white/5"><span class="text-[10px] font-bold truncate max-w-[80px]">${u.nick}</span><button onclick="addWin('${u.nick}')" class="text-green-500 text-[9px] font-bold tracking-wider hover:bg-green-500/10 p-1 rounded">+ WIN (${u.wins||0})</button></div>`).join('');
        };
        window.addWin = async function(n) { 
            const userRef = ref(db, 'users/'+n);
            const snap = await get(userRef);
            if(snap.exists()) { await update(userRef, { wins: (snap.val().wins || 0) + 1 }); }
            else { await set(userRef, { nick: n, wins: 1, tg: '-' }); }
        };

        if(state.player) renderProfile();
        setTimeout(() => updateInterfaceLanguage(), 100);
    </script>

    <script>
        let currentLang = 'ru';
        const langData = {
            ru: {
                adm_title: "–£–ü–†–ê–í–õ–ï–ù–ò–ï", logout: "–í–´–•–û–î", solo: "–°–û–õ–û", squad: "–û–¢–†–Ø–î–´", adm_delete: "–£–î–ê–õ–ò–¢–¨", adm_create: "–°–û–ó–î–ê–¢–¨", adm_players: "–ò–ì–†–û–ö–ò",
                register: "–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø", no_events: "–ù–ï–¢ –ê–ö–¢–ò–í–ù–´–• –°–û–ë–´–¢–ò–ô", bracket: "–°–ï–¢–ö–ê –ú–ê–¢–ß–ï–ô", details: "–î–ï–¢–ê–õ–ò", prize: "–ü–†–ò–ó", format: "–§–û–†–ú–ê–¢", rules: "–ü–†–ê–í–ò–õ–ê",
                participants: "–£–ß–ê–°–¢–ù–ò–ö–ò", join_btn: "–ü–†–ò–ù–Ø–¢–¨ –£–ß–ê–°–¢–ò–ï", reg_tourn_title: "–†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø", create_acc: "–°–û–ó–î–ê–¢–¨ –ê–ö–ö–ê–£–ù–¢", done: "–ì–û–¢–û–í–û", settings: "–ù–ê–°–¢–†–û–ô–ö–ò",
                snow_ctrl: "–£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ù–ï–ì–û–ú", snow_toggle: "–°–ù–ï–ì –í–ö–õ/–í–´–ö–õ", snow_spd: "–°–ö–û–†–û–°–¢–¨", theme: "–¢–ï–ú–ê", active_tourn: "–ê–ö–¢–ò–í–ù–´–ô –¢–£–†–ù–ò–†", about_btn: "–ò–ù–§–û",
                nobody_joined: "–ù–∏–∫—Ç–æ –µ—â–µ –Ω–µ –∑–∞–ø–∏—Å–∞–ª—Å—è", ppl_short: "—á–µ–ª.", already_in: "–í—ã —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ.", confirm_solo: "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —É—á–∞—Å—Ç–∏–µ?", confirm: "–ü–û–î–¢–í–ï–†–î–ò–¢–¨",
                team_name_ph: "–ù–ê–ó–í–ê–ù–ò–ï –û–¢–†–Ø–î–ê", create_squad: "–°–û–ó–î–ê–¢–¨ –û–¢–†–Ø–î", or_join: "–ò–õ–ò –í–°–¢–£–ü–ò–¢–¨", no_squads: "–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ—Ç—Ä—è–¥–æ–≤", you_joined: "–í—ã –≤ –∏–≥—Ä–µ!",
                joined_squad: "–í—ã –≤—Å—Ç—É–ø–∏–ª–∏ –≤ –æ—Ç—Ä—è–¥", updated: "–û–ë–ù–û–í–õ–ï–ù–û", confirm_delete: "–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç—É—Ä–Ω–∏—Ä?", deleted: "–¢—É—Ä–Ω–∏—Ä —É–¥–∞–ª–µ–Ω", fill_all_fields: "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è",
                wins: "–ü–æ–±–µ–¥—ã", edit_profile: "–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –ü–†–û–§–ò–õ–¨", save_changes: "–°–û–•–†–ê–ù–ò–¢–¨", profile_saved: "–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω"
            },
            en: {
                adm_title: "MANAGEMENT", logout: "LOGOUT", solo: "SOLO", squad: "SQUADS", adm_delete: "DELETE", adm_create: "CREATE", adm_players: "PLAYERS",
                register: "REGISTER", no_events: "NO ACTIVE EVENTS", bracket: "MATCH BRACKET", details: "DETAILS", prize: "PRIZE", format: "FORMAT", rules: "RULES",
                participants: "PARTICIPANTS", join_btn: "JOIN TOURNAMENT", reg_tourn_title: "REGISTRATION", create_acc: "CREATE ACCOUNT", done: "DONE", settings: "SETTINGS",
                snow_ctrl: "SNOW CONTROL", snow_toggle: "TOGGLE SNOW", snow_spd: "SPEED", theme: "THEME", active_tourn: "ACTIVE TOURNAMENT", about_btn: "INFO",
                nobody_joined: "No one joined yet", ppl_short: "ppl", already_in: "Already joined.", confirm_solo: "Confirm participation?", confirm: "CONFIRM",
                team_name_ph: "SQUAD NAME", create_squad: "CREATE SQUAD", or_join: "OR JOIN", no_squads: "No open squads", you_joined: "You are in!",
                joined_squad: "Joined successfully", updated: "UPDATED", confirm_delete: "Delete this tournament?", deleted: "Deleted", fill_all_fields: "Fill all fields",
                wins: "Wins", edit_profile: "EDIT PROFILE", save_changes: "SAVE CHANGES", profile_saved: "Profile saved"
            }
        };

        function changeLang(l) { currentLang = l; document.documentElement.lang = l; updateInterfaceLanguage(); if(window.renderMainTournaments) window.renderMainTournaments(); if(window.renderProfile) window.renderProfile(); if(window.renderTournamentList) window.renderTournamentList(); }
        function t(key) { return langData[currentLang][key] || key; }
        window.t = t; 
        function updateInterfaceLanguage() { document.querySelectorAll('[data-lang]').forEach(el => { const k = el.getAttribute('data-lang'); if(langData[currentLang][k]) el.innerText = langData[currentLang][k]; }); const inputs = { 'reg-nick': 'NICKNAME', 'new-team-name': langData[currentLang].team_name_ph }; for(let id in inputs) { if(document.getElementById(id)) document.getElementById(id).placeholder = inputs[id]; } }
        
        function toggleDrawer(id) { 
            closeAllPanels(); 
            const el = document.getElementById(id);
            if(el) el.classList.add('active'); 
            document.getElementById('overlay').style.display = 'block'; 
            document.body.classList.add('modal-open'); 
        }
        
        function closeAllPanels() { 
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('active')); 
            const settings = document.getElementById('settings-panel');
            if(settings) settings.style.transform = 'translateX(100%)'; 
            document.getElementById('overlay').style.display = 'none'; 
            document.body.classList.remove('modal-open'); 
        }
        
        function toggleSettings() { 
            const settings = document.getElementById('settings-panel');
            if(settings) settings.style.transform = 'translateX(0)'; 
            document.getElementById('overlay').style.display = 'block'; 
            document.body.classList.add('modal-open');
        }
        
        function setTheme(t) { document.body.removeAttribute('data-theme'); if(t !== 'void') document.body.setAttribute('data-theme', t); }
        function notify(m, type) { const el = document.createElement('div'); el.className = `glass-panel p-4 text-[10px] font-bold border-l-4 ${type==='success'?'border-green-500': type==='warning'?'border-yellow-500':'border-red-500'} shadow-xl`; el.innerText = m; document.getElementById('notification-area').appendChild(el); setTimeout(() => el.remove(), 3000); }
        
        document.getElementById('admin-code').addEventListener('keypress', (e) => { 
            if(e.key === 'Enter') {
                if (e.target.value === '—É–æ–ª—Ç–µ—Ä –ª—É—á—à–∏–π') { 
                    document.getElementById('admin-dashboard').classList.add('active'); 
                    document.body.classList.add('modal-open');
                    e.target.value = ''; 
                    if(window.fillAdminInputs) window.fillAdminInputs(); 
                } else {
                    notify('ACCESS DENIED', 'error');
                }
            } 
        });
        
        function logoutAdmin() { 
            document.getElementById('admin-dashboard').classList.remove('active'); 
            document.body.classList.remove('modal-open');
        }
        
        const canvas = document.getElementById('snow-canvas'); const ctx = canvas.getContext('2d');
        let snow = [], snowActive = true, snowSpeedMult = 1;
        window.toggleSnow = () => snowActive = !snowActive;
        window.setSnowSpeed = (v) => snowSpeedMult = parseFloat(v);
        window.changeLang = changeLang;
        
        function resize() { 
            canvas.width = window.innerWidth; 
            canvas.height = window.innerHeight; 
        }
        window.onresize = resize; resize();
        
        function initSnow() { snow = []; const cnt = Math.min(100, window.innerWidth/5); for(let i=0; i<cnt; i++) snow.push({x:Math.random()*canvas.width, y:Math.random()*canvas.height, s:Math.random()*2, v:Math.random()*1+0.5}); }
        initSnow();
        function anim() { ctx.clearRect(0,0,canvas.width,canvas.height); if(snowActive) { ctx.fillStyle = "white"; ctx.globalAlpha = 0.15; snow.forEach(p => { p.y += p.v * snowSpeedMult; if(p.y > canvas.height) { p.y = -10; p.x = Math.random() * canvas.width; } ctx.beginPath(); ctx.arc(p.x, p.y, p.s, 0, Math.PI*2); ctx.fill(); }); } requestAnimationFrame(anim); }
        anim();
        window.addEventListener('resize', initSnow);

        // MOBILE KEYBOARD FIX
        // –ö–æ–≥–¥–∞ —Ñ–æ–∫—É—Å –Ω–∞ –∏–Ω–ø—É—Ç–µ, —Å–∫—Ä–æ–ª–ª–∏–º –µ–≥–æ –≤ —Ü–µ–Ω—Ç—Ä, —á—Ç–æ–±—ã –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –Ω–µ –∑–∞–∫—Ä—ã–≤–∞–ª–∞
        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('focus', () => {
                setTimeout(() => {
                    input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 300); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
            });
        });
    </script>
</body>
</html>
